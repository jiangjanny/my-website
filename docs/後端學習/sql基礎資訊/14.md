---
slug: 多表查詢
title: 多表查詢
authors:
    name: Janny
    title: 多表查詢
    url: https://github.com/jiangjanny
    image_url: https://avatars.githubusercontent.com/u/109901097?s=96&v=4
tags: [SQL]
---

多表查詢是 SQL 中常見的操作，用於從多個表中提取相關的數據。以下是一些常見的多表查詢方法：

### 1. INNER JOIN（內部連接）

`INNER JOIN` 會返回兩個表中符合條件的交集部分，未符合條件的行將被排除。

```sql
SELECT 表1.欄位1, 表2.欄位2
FROM 表1
INNER JOIN 表2 ON 表1.共同欄位 = 表2.共同欄位;
```

### 2. LEFT JOIN（左外部連接）

`LEFT JOIN` 會返回左表中的所有行，即使右表中沒有匹配的行，右表中無匹配的行則顯示 NULL。

```sql
SELECT 表1.欄位1, 表2.欄位2
FROM 表1
LEFT JOIN 表2 ON 表1.共同欄位 = 表2.共同欄位;
```

### 3. RIGHT JOIN（右外部連接）

`RIGHT JOIN` 是 `LEFT JOIN` 的反向操作，返回右表中的所有行，即使左表中沒有匹配的行。

```sql
SELECT 表1.欄位1, 表2.欄位2
FROM 表1
RIGHT JOIN 表2 ON 表1.共同欄位 = 表2.共同欄位;
```

### 4. FULL OUTER JOIN（全外部連接）

`FULL OUTER JOIN` 會返回兩個表中所有的行，並將匹配的行組合，未匹配的部分以 NULL 顯示。

```sql
SELECT 表1.欄位1, 表2.欄位2
FROM 表1
FULL OUTER JOIN 表2 ON 表1.共同欄位 = 表2.共同欄位;
```

### 5. CROSS JOIN（交叉連接）

`CROSS JOIN` 會返回兩個表的笛卡爾積，將每一行與另一表的每一行配對，行數會是兩表行數的乘積。

```sql
SELECT 表1.欄位1, 表2.欄位2
FROM 表1
CROSS JOIN 表2;
```

### 6. UNION（聯合）

`UNION` 用於合併多個 SELECT 查詢的結果，要求所有查詢返回的欄位數目和數據類型相同。

```sql
SELECT 欄位1, 欄位2 FROM 表1
UNION
SELECT 欄位1, 欄位2 FROM 表2;
```

這些查詢方法讓我們可以從多個表中提取所需的相關數據，根據具體的業務需求選擇合適的查詢方式。需要注意的是，`JOIN` 操作中的匹配條件十分重要，它們直接影響查詢結果的正確性。

## 範例

假設我們有兩個表：`customers`（顧客）和 `orders`（訂單）。

### 表結構

**customers** 表：
| customer_id | name | city |
|-------------|---------|------------|
| 1 | Alice | Taipei |
| 2 | Bob | Taichung |
| 3 | Charlie | Kaohsiung |

**orders** 表：
| order_id | customer_id | amount |
|----------|-------------|--------|
| 101 | 1 | 150 |
| 102 | 2 | 200 |
| 103 | 1 | 300 |
| 104 | 3 | 120 |

### 1. INNER JOIN 範例

查詢每個顧客及其訂單資訊：

```sql
SELECT customers.name, orders.order_id, orders.amount
FROM customers
INNER JOIN orders ON customers.customer_id = orders.customer_id;
```

**結果：**
| name | order_id | amount |
|---------|----------|--------|
| Alice | 101 | 150 |
| Bob | 102 | 200 |
| Alice | 103 | 300 |
| Charlie | 104 | 120 |

### 2. LEFT JOIN 範例

查詢所有顧客及其訂單資訊，即使該顧客沒有訂單。

```sql
SELECT customers.name, orders.order_id, orders.amount
FROM customers
LEFT JOIN orders ON customers.customer_id = orders.customer_id;
```

**結果：**
| name | order_id | amount |
|---------|----------|--------|
| Alice | 101 | 150 |
| Bob | 102 | 200 |
| Alice | 103 | 300 |
| Charlie | 104 | 120 |

### 3. RIGHT JOIN 範例

查詢所有訂單及其對應的顧客資訊，即使有些訂單沒有對應顧客（較少使用）。

```sql
SELECT customers.name, orders.order_id, orders.amount
FROM customers
RIGHT JOIN orders ON customers.customer_id = orders.customer_id;
```

**結果：**
| name | order_id | amount |
|---------|----------|--------|
| Alice | 101 | 150 |
| Bob | 102 | 200 |
| Alice | 103 | 300 |
| Charlie | 104 | 120 |

### 4. FULL OUTER JOIN 範例

查詢所有顧客和訂單，包括那些沒有匹配的行（在一些資料庫系統中不支持）。

```sql
SELECT customers.name, orders.order_id, orders.amount
FROM customers
FULL OUTER JOIN orders ON customers.customer_id = orders.customer_id;
```

**結果：**
| name | order_id | amount |
|---------|----------|--------|
| Alice | 101 | 150 |
| Bob | 102 | 200 |
| Alice | 103 | 300 |
| Charlie | 104 | 120 |

### 5. UNION 範例

將顧客和訂單數據合併成單一列表（欄位類型需一致）。

```sql
SELECT name, city FROM customers
UNION
SELECT order_id, amount FROM orders;
```

**結果：**
| name | city |
|---------|-----------|
| Alice | Taipei |
| Bob | Taichung |
| Charlie | Kaohsiung |
| 101 | 150 |
| 102 | 200 |
| 103 | 300 |
| 104 | 120 |

### 迪卡爾積（Cartesian Product）

迪卡爾積（Cartesian Product）是一種多表查詢方法，使用 `CROSS JOIN` 來實現，會返回兩個表的所有可能組合。具體來說，每個表中的每一行都會與另一表的每一行配對，因此結果表的行數是兩個表行數的乘積。

### 迪卡爾積的使用範例

假設有以下兩個表：

**products** 表（產品）：
| product_id | product_name |
|------------|--------------|
| 1 | Pen |
| 2 | Notebook |

**suppliers** 表（供應商）：
| supplier_id | supplier_name |
|-------------|---------------|
| 101 | Supplier A |
| 102 | Supplier B |

### SQL 查詢

我們使用 `CROSS JOIN` 來實現迪卡爾積：

```sql
SELECT products.product_name, suppliers.supplier_name
FROM products
CROSS JOIN suppliers;
```

### 結果

| product_name | supplier_name |
| ------------ | ------------- |
| Pen          | Supplier A    |
| Pen          | Supplier B    |
| Notebook     | Supplier A    |
| Notebook     | Supplier B    |

### 解析

-   表 `products` 中有 2 行，`suppliers` 中也有 2 行，最終結果中有 \( 2 \times 2 = 4 \) 行。
-   `CROSS JOIN` 返回每個產品與每個供應商的所有可能組合。

### 注意事項

1. **避免過大結果集**：迪卡爾積可能會產生非常大的結果集，特別是當兩個表都包含大量數據時，因此要謹慎使用。
2. **篩選條件**：通常情況下，會在 `WHERE` 子句中添加條件來過濾掉不需要的組合，避免產生過多無用的數據。

如果你需要的是所有組合（如測試所有可能情境），迪卡爾積是合適的工具；但在實際業務中，通常會搭配條件篩選使用，以控制查詢結果的大小和相關性。

## 多表查詢的分類

| **查詢類型**                    | **說明**                                             | **是否需要條件** | **返回結果**                                 |
| ------------------------------- | ---------------------------------------------------- | ---------------- | -------------------------------------------- |
| **內連接 (INNER JOIN)**         | 只返回兩表中符合條件的匹配記錄                       | 是               | 只顯示兩表中都有匹配的記錄                   |
| **左外連接 (LEFT OUTER JOIN)**  | 返回左表中所有記錄，即使右表中沒有匹配記錄也顯示為空 | 是               | 左表全部記錄，右表中沒有匹配的記錄會顯示為空 |
| **右外連接 (RIGHT OUTER JOIN)** | 返回右表中所有記錄，即使左表中沒有匹配記錄也顯示為空 | 是               | 右表全部記錄，左表中沒有匹配的記錄會顯示為空 |
| **全外連接 (FULL OUTER JOIN)**  | 返回兩表中所有記錄，無論有無匹配，未匹配部分顯示為空 | 是               | 兩表的所有記錄，未匹配的部分顯示為空         |
| **交叉連接 (CROSS JOIN)**       | 返回兩表的笛卡兒積，即所有可能的記錄組合             | 否               | 兩表的所有記錄組合，記錄數為兩表記錄數的乘積 |
| **自然連接 (NATURAL JOIN)**     | 自動根據同名且同類型的欄位連接                       | 否               | 自動匹配兩表中同名欄位的記錄                 |
| **自連接 (SELF JOIN)**          | 將表格自身作為兩個不同表來進行連接                   | 是               | 針對同一張表進行比較的結果                   |
| **複合連接 (COMPOSITE JOIN)**   | 根據多個條件連接兩個表                               | 是               | 符合所有條件的記錄                           |

### 等值連結 VS 非等值連結

等值連接與非等值連接是多表查詢中的兩種常見方式，主要根據連接條件的不同來分類。以下是這兩種連接的比較：

| **連接類型**                   | **說明**                                       | **連接條件**        | **適用情況**                               | **返回結果**             |
| ------------------------------ | ---------------------------------------------- | ------------------- | ------------------------------------------ | ------------------------ |
| **等值連接 (Equi Join)**       | 透過欄位之間的相等關係連接兩個或多個表格       | =                   | 當需要將表中相同欄位值的記錄進行匹配時使用 | 只返回符合等值條件的記錄 |
| **非等值連接 (Non-Equi Join)** | 透過欄位之間的非等值條件（例如 <, >, != 等連接 | >, <, !=, <=, >= 等 | 當需要將不相等或在某範圍內的記錄連接時使用 | 返回符合非等值條件的記錄 |

### **詳細說明**

1. **等值連接 (Equi Join)**

    - **連接條件**：使用等號（=）作為連接條件。
    - **應用場景**：適用於在不同表中查找欄位值相同的記錄。例如，連接員工表與部門表時，根據 `DepartmentID` 進行等值匹配。
    - **示例 SQL**：
        ```sql
        SELECT a.*, b.*
        FROM TableA a
        INNER JOIN TableB b ON a.id = b.id;
        ```

2. **非等值連接 (Non-Equi Join)**
    - **連接條件**：使用非等值操作符（如 <, >, != 等）作為連接條件。
    - **應用場景**：當需要根據範圍或非相等條件來連接表時使用。例如，連接銷售記錄表和折扣表時，根據價格範圍應用不同折扣。
    - **示例 SQL**：
        ```sql
        SELECT a.*, b.*
        FROM Sales a
        JOIN Discounts b ON a.price > b.min_price AND a.price < b.max_price;
        ```

### **總結**

-   **等值連接** 是最常見的連接方式，適用於匹配欄位值相等的記錄。
-   **非等值連接** 更靈活，可以根據更廣泛的條件來連接表格。

### 自連結 vs 非自連結

自連接與非自連接是多表查詢中的兩個分類，主要區別在於查詢中是否使用同一張表進行連接。以下是這兩種連接方式的比較：

| **連接類型**                 | **說明**                                           | **適用情況**                             | **返回結果**                             |
| ---------------------------- | -------------------------------------------------- | ---------------------------------------- | ---------------------------------------- |
| **自連接 (Self Join)**       | 將同一張表作為兩個不同表進行連接，對比表中不同記錄 | 當需要在同一張表內部進行比較或關聯時使用 | 連接並返回符合條件的同一表中記錄間的關係 |
| **非自連接 (Non-Self Join)** | 連接多個不同的表，根據連接條件進行數據匹配與篩選   | 當需要跨多個表進行關聯時使用             | 連接並返回符合條件的不同表之間的記錄     |

### **詳細說明**

1. **自連接 (Self Join)**

    - **使用方式**：自連接是將一張表自身重複使用，視為兩個不同的表，通常需要使用別名來區分。
    - **應用場景**：適用於需要在同一表中進行記錄間比較、層次結構處理或查找如主管和下屬關係等情況。
    - **示例 SQL**：
        ```sql
        SELECT e1.EmployeeName AS Manager, e2.EmployeeName AS Subordinate
        FROM Employees e1
        JOIN Employees e2 ON e1.EmployeeID = e2.ManagerID;
        ```
    - **結果**：例如，查詢員工表中每個員工與其主管的關係。

2. **非自連接 (Non-Self Join)**
    - **使用方式**：將兩個或多個不同的表格連接在一起，根據欄位間的匹配條件進行連接。
    - **應用場景**：用於不同表之間的數據關聯，如訂單與客戶、產品與類別等。
    - **示例 SQL**：
        ```sql
        SELECT o.OrderID, c.CustomerName
        FROM Orders o
        JOIN Customers c ON o.CustomerID = c.CustomerID;
        ```
    - **結果**：查詢訂單表與客戶表中的匹配記錄。

### **總結**

-   **自連接** 適用於同一表內部記錄之間的比較或關聯，適合層次結構和自參考的數據。
-   **非自連接** 適用於不同表之間的關聯，是資料庫查詢中最常見的連接方式。

### 內連結 vs 外連結

內連接與外連接是多表查詢中最常用的連接類型，主要區別在於是否保留不匹配的記錄。以下是這兩種連接方式的比較：

| **連接類型**            | **說明**                                                           | **連接條件** | **適用情況**                               | **返回結果**                                 |
| ----------------------- | ------------------------------------------------------------------ | ------------ | ------------------------------------------ | -------------------------------------------- |
| **內連接 (INNER JOIN)** | 只返回兩表中符合連接條件的匹配記錄                                 | 是           | 當只需要匹配記錄時使用                     | 返回兩表中符合條件的記錄，不包括不匹配的記錄 |
| **外連接 (OUTER JOIN)** | 返回至少一個表中的所有記錄，無論是否匹配，分為左外、右外和全外連接 | 是           | 當需要保留其中一個表或兩表的所有記錄時使用 | 返回匹配記錄和未匹配記錄，未匹配部分顯示為空 |

### **詳細說明**

1. **內連接 (INNER JOIN)**

    - **說明**：內連接僅返回兩個表中符合連接條件的記錄。如果一個表中有未匹配的記錄，這些記錄將不會出現在結果中。
    - **應用場景**：當只需要查詢兩個表中都有匹配的數據時。例如，查詢所有有訂單的客戶。
    - **示例 SQL**：
        ```sql
        SELECT a.*, b.*
        FROM TableA a
        INNER JOIN TableB b ON a.id = b.id;
        ```
    - **結果**：僅返回 `TableA` 和 `TableB` 中 `id` 值匹配的記錄。

2. **外連接 (OUTER JOIN)**
   外連接可分為三種類型：
    - **左外連接 (LEFT OUTER JOIN)**：返回左表中所有記錄，即使右表中沒有匹配的記錄也顯示為空。
        - **應用場景**：當需要查詢左表的所有記錄及其匹配或未匹配的數據時。
        - **示例 SQL**：
            ```sql
            SELECT a.*, b.*
            FROM TableA a
            LEFT JOIN TableB b ON a.id = b.id;
            ```
        - **結果**：返回 `TableA` 的所有記錄，即使 `TableB` 中沒有匹配的 `id`。
    - **右外連接 (RIGHT OUTER JOIN)**：返回右表中所有記錄，即使左表中沒有匹配的記錄也顯示為空。
        - **應用場景**：當需要查詢右表的所有記錄及其匹配或未匹配的數據時。
        - **示例 SQL**：
            ```sql
            SELECT a.*, b.*
            FROM TableA a
            RIGHT JOIN TableB b ON a.id = b.id;
            ```
        - **結果**：返回 `TableB` 的所有記錄，即使 `TableA` 中沒有匹配的 `id`。
    - **全外連接 (FULL OUTER JOIN)**：返回兩表中的所有記錄，無論是否有匹配，未匹配的部分顯示為空。
        - **應用場景**：當需要查詢兩表所有記錄，包括所有的匹配與未匹配部分。
        - **示例 SQL**：
            ```sql
            SELECT a.*, b.*
            FROM TableA a
            FULL OUTER JOIN TableB b ON a.id = b.id;
            ```
        - **結果**：返回 `TableA` 和 `TableB` 中所有的記錄，未匹配部分以空值顯示。

### **總結**

-   **內連接** 用於提取兩表中符合條件的記錄，是最精簡的查詢方式。
-   **外連接** 則更為寬鬆，允許返回至少一個表中的所有記錄，即使沒有匹配的數據，適用於需要查看完整數據集時。
